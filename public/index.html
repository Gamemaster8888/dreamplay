<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DreamPlay Auto-Register (Polygon)</title>
  <style>
    :root{--bg:#0c0f16;--card:#121625;--muted:#9aa3b2;--accent:#06D6A0;--warn:#FFD166;--err:#EF476F;--ok:#06D6A0;}
    body{font-family:system-ui,Arial,sans-serif;background:var(--bg);color:#e7ecf5;margin:0;padding:24px;}
    h1{margin:10px 0 6px;color:#FFD166;}
    .card{max-width:860px;margin:0 auto;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,.25);}
    p,li{color:#cdd6e3;}
    code{background:#1a1d27;padding:2px 6px;border-radius:4px;color:#9FE7D3;}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:14px 0;}
    button{background:var(--accent);color:#0c0f16;border:0;border-radius:8px;padding:10px 16px;font-weight:600;cursor:pointer;}
    button.secondary{background:#2a3146;color:#d9e2f0;}
    button.warn{background:var(--warn);color:#111;}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;margin:14px 0;}
    .muted{color:var(--muted);}
    .ok{color:var(--ok);}
    .err{color:var(--err);}
    .log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;background:#0f1320;border:1px solid #1c2237;padding:10px;border-radius:8px;max-height:280px;overflow:auto;}
  </style>
</head>
<body>
  <div class="card">
    <h1>DreamPlay Auto-Register</h1>
    <p class="muted">Connect wallet ‚Üí check allowlist ‚Üí register on Polygon mainnet.</p>

    <div class="kv">
      <div>Contract:</div><div><code id="contractAddr">0xF8d3395c2ff16A1881147a3Ae0fBD7C33De13Ad4</code></div>
      <div>Network:</div><div id="networkStatus" class="muted">Detecting‚Ä¶</div>
      <div>Account:</div><div id="acct" class="muted">Not connected</div>
      <div>Allowlist API:</div><div><code>/.netlify/functions/referrer-sign?buyer=0x‚Ä¶</code></div>
    </div>

    <div class="row">
      <button id="btnConnect">üåå Connect Wallet</button>
      <button id="btnAllow" class="secondary">üîé Test Allowlist</button>
      <button id="btnRegister">‚úÖ Register Now</button>
      <button id="btnClear" class="warn">‚ôªÔ∏è Reload</button>
    </div>

    <div class="kv">
      <div>Allowlist:</div><div id="allowlistStatus" class="muted">Not tested</div>
      <div>Payload:</div><div id="payload" class="muted">‚Äî</div>
      <div>Tx Result:</div><div id="tx" class="muted">‚Äî</div>
    </div>

    <h3>Logs</h3>
    <div id="log" class="log"></div>
  </div>

  <!-- ‚úÖ Load ethers.js FIRST -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Then your custom script -->
  <script>
  const CONTRACT_ADDRESS = "0xF8d3395c2ff16A1881147a3Ae0fBD7C33De13Ad4";
  const ABI = [
    "function registerReferrer(address referrer,uint256 deadline,bytes calldata sig) external",
    "function referrerOf(address) view returns (address)"
  ];
  const POLYGON_MAINNET = "0x89";

  const el = id => document.getElementById(id);
  const log = (...a)=>{console.log(...a);el('log').textContent += a.join(' ') + "\n";}
  const set = (id, html, cls)=>{const e=el(id);e.innerHTML=html;if(cls){e.className='';e.classList.add(cls)}}

  let provider, signer, account, contract;

  async function ensureNetwork(){
    if(!window.ethereum){set('networkStatus','MetaMask not found','err');return false;}
    const cid=await window.ethereum.request({method:'eth_chainId'}).catch(()=>null);
    if(cid!==POLYGON_MAINNET){
      set('networkStatus',`Wrong network (${cid}). Switching‚Ä¶`,'warn');
      try{
        await window.ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:POLYGON_MAINNET}]});
        set('networkStatus','Polygon mainnet ‚úÖ','ok');return true;
      }catch(e){
        set('networkStatus','Please switch to Polygon manually','err');return false;
      }
    }
    set('networkStatus','Polygon mainnet ‚úÖ','ok');return true;
  }

  async function connectWallet(){
    const ok=await ensureNetwork();if(!ok)return;
    provider=new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts",[]);
    signer=provider.getSigner();
    account=await signer.getAddress();
    contract=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
    window.contractInstance=contract;
    set('acct',account,'ok');
    log("Connected:",account);
    return account;
  }

  async function testAllowlist(){
    if(!account)await connectWallet();
    try{
      const url='/.netlify/functions/referrer-sign?buyer='+account;
      log('Fetching:',url);
      const res=await fetch(url);
      if(!res.ok){const t=await res.text();set('allowlistStatus','‚ùå '+t,'err');return;}
      const data=await res.json();
      set('allowlistStatus','‚úÖ Payload received','ok');
      set('payload',`<code>${data.referrer}<br>${data.deadline}<br>${data.signature.slice(0,18)}‚Ä¶</code>`);
      log('Payload',data);
      return data;
    }catch(e){set('allowlistStatus','‚ùå '+e.message,'err');}
  }

  window.tryAutoRegister=async function(acct,ctr){
    try{
      const res=await fetch('/.netlify/functions/referrer-sign?buyer='+acct);
      if(!res.ok)throw new Error('Allowlist error '+res.status);
      const p=await res.json();
      log('Registering',p);
      const tx=await ctr.registerReferrer(p.referrer,p.deadline,p.signature);
      set('tx','‚è≥ Pending‚Ä¶','muted');
      const rc=await tx.wait();
      set('tx','‚úÖ Conf
